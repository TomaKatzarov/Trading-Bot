{% extends "base.html" %}

{% block content %}
<div class="wrapper">
  <div class="sidebar">
    <div class="sidebar-wrapper">
      <!-- LoRA Status Card (existing content) -->
      <div class="card card-stats">
        <div class="card-header card-header-warning card-header-icon">
          <div class="card-icon">
            <i class="material-icons">settings_input_component</i>
          </div>
          <h3 class="card-title">LoRA Adapter Status</h3>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h4 class="card-title">
                Version: {{ adapter_version|default('N/A') }}
              </h4>
              <div class="stats">
                <i class="material-icons text-{{ 'success' if lora_status.healthy else 'danger' }}">circle</i>
                {{ lora_status.status|default('Not Loaded') }}
              </div>
              <div class="mt-2 small text-muted">
                <i class="tim-icons icon-paper"></i>
                Path: models/adapters/trading_lora.bin
              </div>
            </div>
            <div class="col-md-6">
              <div class="stats">
                <p class="card-category">Confidence Boost</p>
                <h4 class="card-title">{{ lora_stats.confidence_boost|default(0)|round(1) }}%</h4>
              </div>
              <div class="stats">
                <p class="card-category">Last Updated</p>
                <h4 class="card-title">{{ lora_status.last_updated|default('Never') }}</h4>
              </div>
              <div class="progress-container mt-3">
                <div class="progress-label">
                  <span class="text-primary">Retrain Progress</span>
                </div>
                <div class="progress">
                  <div class="progress-bar bg-info" role="progressbar" 
                       aria-valuenow="{{ lora_stats.retrain_progress|default(0) }}" 
                       aria-valuemin="0" aria-valuemax="100"
                       style="width: {{ lora_stats.retrain_progress|default(0) }}%">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <div class="stats">
            <i class="material-icons">update</i> Model Adapter Metrics
          </div>
          <button class="btn btn-sm btn-warning float-right" 
                  id="retrain-btn"
                  data-toggle="tooltip"
                  title="Manual retrain trigger"
                  aria-label="Initiate LoRA retraining">
            <i class="tim-icons icon-refresh-02"></i> Retrain Now
          </button>
        </div>
      </div>
      <div class="logo">
        <a href="/" class="simple-text logo-normal">Trading Bot</a>
      </div>
      <ul class="nav">
        <li class="active">
          <a href="/">
            <i class="tim-icons icon-chart-pie-36"></i>
            <p>Dashboard</p>
          </a>
        </li>
        <li>
          <a href="/settings">
            <i class="tim-icons icon-settings-gear-63"></i>
            <p>Settings</p>
          </a>
        </li>
      </ul>
      <!-- Symbol Selection -->
      <div class="card mt-3">
        <div class="card-header">
          <h5>Select Trading Symbol</h5>
        </div>
        <div class="card-body">
          <select id="symbol-select" class="form-control">
            {% for sector, symbols in sectors.items() %}
              <optgroup label="{{ sector }}">
                {% for sym in symbols %}
                  <option value="{{ sym }}">{{ sym }}</option>
                {% endfor %}
              </optgroup>
            {% endfor %}
            {% if indices %}
              {% for index, symbols in indices.items() %}
                <optgroup label="{{ index }}">
                  {% for sym in symbols %}
                    <option value="{{ sym }}">{{ sym }}</option>
                  {% endfor %}
                </optgroup>
              {% endfor %}
            {% endif %}
          </select>
          <button id="set-symbol-btn" class="btn btn-primary btn-block mt-2">Set Symbol</button>
        </div>
      </div>
    </div>
  </div>

  <div class="main-panel">
    <nav class="navbar navbar-expand-lg navbar-absolute navbar-transparent">
      <div class="container-fluid">
        <div class="navbar-wrapper">
          <div class="navbar-toggle d-inline">
            <button type="button" class="navbar-toggler">
              <span class="navbar-toggler-bar bar1"></span>
              <span class="navbar-toggler-bar bar2"></span>
              <span class="navbar-toggler-bar bar3"></span>
            </button>
          </div>
          <a class="navbar-brand" href="#">{{ current_symbol }} - {{ current_timeframe }}</a>
        </div>
      </div>
    </nav>

    <div class="content">
      <div class="row">
        <!-- (Existing dashboard charts and panels here) -->
      </div>
    </div>
    <!-- Manual Close Position Modal -->
    <div id="manual-close-modal" class="modal fade" role="dialog" aria-labelledby="manualCloseTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark">
          <div class="modal-header border-0">
            <h4 class="modal-title text-warning" id="manualCloseTitle">Manual Close Position</h4>
            <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="manual-close-form">
              <div class="form-group">
                <label for="close-symbol">Symbol</label>
                <input type="text" class="form-control" id="close-symbol" readonly>
              </div>
              <div class="form-group">
                <label for="exit-price">Exit Price</label>
                <input type="number" step="0.01" class="form-control" id="exit-price" required>
              </div>
              <div class="form-group">
                <label for="close-reason">Reason</label>
                <input type="text" class="form-control" id="close-reason" placeholder="Enter reason" required>
              </div>
            </form>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-success" id="confirm-close-btn">Close Position</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/core/jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/core/popper.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/core/bootstrap.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/plugins/perfect-scrollbar.jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/black-dashboard.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
(function() {
  // Set trading symbol event
  $('#set-symbol-btn').on('click', function() {
    const selectedSymbol = $('#symbol-select').val();
    $.ajax({
      url: '/set_symbol',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ symbol: selectedSymbol }),
      success: function(response) {
        if(response.status === 'success'){
          alert("Active symbol set to " + response.symbol);
          location.reload();
        } else {
          alert(response.message);
        }
      },
      error: function(err) {
        console.error(err);
        alert("Error setting symbol.");
      }
    });
  });

  // When a user clicks a position in the positions table (assumed to be rendered via WebSocket),
  // open the manual close modal with the symbol pre-filled.
  $(document).on('click', '.position-row', function() {
    const symbol = $(this).data('symbol');
    $('#close-symbol').val(symbol);
    $('#manual-close-modal').modal('show');
  });

  // Handle manual close form submission.
  $('#confirm-close-btn').on('click', function() {
    const symbol = $('#close-symbol').val();
    const exitPrice = $('#exit-price').val();
    const reason = $('#close-reason').val();
    $.ajax({
      url: '/close_position',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ symbol: symbol, exit_price: exitPrice, reason: reason }),
      success: function(response) {
        if(response.status === 'success'){
          alert("Position for " + symbol + " closed. PnL: " + response.pnl);
          $('#manual-close-modal').modal('hide');
          // Optionally, refresh positions via a WebSocket or AJAX call.
        } else {
          alert(response.message);
        }
      },
      error: function(err) {
        console.error(err);
        alert("Error closing position.");
      }
    });
  });

  // (Existing WebSocket and other scripts remain unchanged)
})();
</script>
{% endblock %}
